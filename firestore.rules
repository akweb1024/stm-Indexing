rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Deny all access by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Get the user's role and tenantId from their user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if the user is a super_admin
    function isSuperAdmin() {
      return getUserData().role == 'super_admin';
    }

    // Check if the user is a journal_manager
    function isJournalManager() {
      return getUserData().role == 'journal_manager';
    }

    // Check if the user is an editor
    function isEditor() {
      return getUserData().role == 'editor';
    }

    // Check if the user is an auditor
    function isAuditor() {
      return getUserData().role == 'auditor';
    }

    // Check if the user belongs to the same tenant as the resource
    function isSameTenant(resource) {
      return getUserData().tenantId == resource.data.tenantId;
    }

    // users
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isSuperAdmin();
      allow write: if isSuperAdmin();
    }

    // journals
    match /journals/{journalId} {
      allow read: if (isSuperAdmin() || isJournalManager() || isEditor()) && (journalId in getUserData().assignedJournalIDs);
      allow create: if isSuperAdmin() || isJournalManager();
      allow update: if (isSuperAdmin() || isJournalManager()) && (journalId in getUserData().assignedJournalIDs);
      // Deny read access to wpSecretRef for all users
      allow read: if request.auth.uid != null && resource.data.wpSecretRef != null == false;
    }

    // papers
    match /papers/{paperId} {
        allow read, write: if (isSuperAdmin() || isJournalManager() || isEditor()) && (request.resource.data.journalId in getUserData().assignedJournalIDs);
    }

    // indexing_applications
    match /indexing_applications/{appId} {
        allow read, write: if (isSuperAdmin() || isJournalManager()) && (request.resource.data.journalId in getUserData().assignedJournalIDs);
    }

    // database_configs
    match /database_configs/{dbName} {
      allow read: if request.auth.uid != null;
      allow write: if isSuperAdmin();
    }

    // audit_logs
    match /audit_logs/{logId} {
      allow read: if isSuperAdmin() || isAuditor();
      allow write: if false; // Can only be written to by functions
    }

    // tasks
    match /tasks/{taskId} {
        allow read, write: if (isSuperAdmin() || isJournalManager() || isEditor()) && (request.resource.data.journalId in getUserData().assignedJournalIDs);
    }
  }
}
